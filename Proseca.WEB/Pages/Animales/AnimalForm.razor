@using Microsoft.AspNetCore.Authorization
@using Proseca.Shared.Entidades
@using Microsoft.AspNetCore.Authorization
@inject SweetAlertService swal
@inject IRepository repository

@attribute [Authorize(Roles = "Admin")]



<NavigationLock OnBeforeInternalNavigation="OnBeforeInternalNavigation"></NavigationLock>


<EditForm EditContext="editContext">

    <DataAnnotationsValidator />

    <div class="mb-3">

        <label>Identificador del animal</label>
        <div>

            <InputText width="10" @bind-Value="Animal.Chapeta" />

        </div>

    </div>

    <div class="mb-3">

        <label>Nombre del animal</label>
        <div>

            <InputText width="10" @bind-Value="Animal.Nombre" />

        </div>

    </div>


    <div class="mb-3">
        <label>Imagen</label>
        <div>
            <InputText width="10" @bind-Value="Animal.ImagenUrl" />
        </div>
    </div>


    <div class="mb-3">

        <label>Sexo</label>
        <div>
            <InputSelect @bind-Value="Animal.Sexo" class="form-control" style="width: 200px;">
                <option value="">Seleccionar Raza</option> <!-- Opción por defecto -->
                <option value="Hembra">Hembra</option>
                <option value="Macho">Macho</option>
            </InputSelect>

        </div>

    </div>


    <div class="mb-3">

        <label>Fecha Nacimiento</label>
        <div>


            <InputDate @bind-Value="Animal.FechaN" class="form-control" style="max-width:200px" />

        </div>

    </div>

    <div class="mb-3">
        <label>Edad del animal</label>
        <div>
            <span>@EdadAnimal años</span> <!-- Muestra la edad del animal -->
        </div>
    </div>

    <div class="mb-3">

        <label>Identificador del padre</label>
        <div>

            <InputText width="10" @bind-Value="Animal.Padre" />

        </div>

    </div>

    <div class="mb-3">

        <label>Identificador de la madre</label>
        <div>

            <InputText width="10" @bind-Value="Animal.Madre" />

        </div>

    </div>
    <div class="mb-3">

        <label>Raza del animal</label>
        <div>

            <InputText width="10" @bind-Value="Animal.Raza" />

        </div>

    </div>
    <div class="mb-3">

        <label>Peso del animal en Kg </label>
        <div>

            <InputNumber @bind-Value="Animal.peso" />

        </div>

    </div>

    <div class="mb-3">

        <label>Color del animal</label>
        <div>

            <InputText width="10" @bind-Value="Animal.Color" />

        </div>

    </div>

    <div class="mb-3">
        <label>Finca</label>
        <InputSelect class="form-control" style="width: 200px;" @bind-Value="Animal.FincaId">
            <option value="">Seleccionar Finca</option> <!-- Opción por defecto -->
            @foreach (var Finca in Fincas)
            {
                <option value="@Finca.Id">@Finca.Nombre</option>
            }
        </InputSelect>
    </div>



    <button class="btn btn-primary" type="button" @onclick="OnSubmit">Guardar</button>
    <button class="btn btn-success" type="button" @onclick="ReturnAction">Regresar</button>


</EditForm>



@code {

    public List<Finca> Fincas { get; set; } = new List<Finca>();

    protected override async Task OnInitializedAsync()
    {
        editContext = new(Animal);
        Animal.FechaN = DateTime.Parse("2023-01-01");

        var responseHppt = await repository.GetAsync<List<Finca>>("/api/Fincas");
        Fincas = responseHppt.Response!.ToList();



    }




    private EditContext editContext = null;


    protected override void OnInitialized()

    {

        editContext = new(Animal);
    }

    [EditorRequired]

    [Parameter]

    public Animal Animal { get; set; }

    [EditorRequired]

    [Parameter]

    public EventCallback OnSubmit { get; set; }





    [EditorRequired]

    [Parameter]

    public EventCallback ReturnAction { get; set; }



    public bool FormPostedSuccessfully { get; set; } = false;



    private async Task OnBeforeInternalNavigation(LocationChangingContext context)

    {

        Console.WriteLine("guardando data");

        var formWasEdited = editContext.IsModified();



        if (!formWasEdited)

        {

            return;

        }



        if (FormPostedSuccessfully)

        {

            return;

        }



        var result = await swal.FireAsync(new SweetAlertOptions
            {
                Title = "Confirmación",
                Text = "¿Deseas abandonar la página y perder los cambios?",
                Icon = SweetAlertIcon.Warning,
                ShowCancelButton = true
            });



        var confirm = !string.IsNullOrEmpty(result.Value);


        if (confirm)

        {

            return;

        }


        context.PreventNavigation();

    }
    // calcular edad
    public int EdadAnimal
    {
        get
        {
            if (Animal.FechaN == null || Animal.Sexo == null)
            {
                return 0; // Retorna 0 si la fecha de nacimiento no está definida
            }

            var edad = DateTime.Today.Year - Animal.FechaN.Year;
            if (DateTime.Today < Animal.FechaN.AddYears(edad))
            {
                edad--;
            }

            return edad;
        }
    }

}
